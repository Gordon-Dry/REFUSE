//
// All configuration related to engine performance
//

//
// IMPORTANT NOTES:
//
// OR statements (symbol: |) do not work inside a HAS statement: https://forum.kerbalspaceprogram.com/index.php?/topic/50533-15x-module-manager-311-november-12th-2018-its-dangerous-to-go-alone-take-those-cats-with-you/&do=findComment&comment=3335515
// Engines should be patched in one step if at all possible, to avoid half-patching multi-mode engines for example 
//

REFUSE_EnginesConfiguration
{
}

//
// Global settings
//

@REFUSE_EnginesConfiguration:BEFORE[ZZZ_REFUSE]
{
    // Based on https://en.wikipedia.org/wiki/Comparison_of_orbital_rocket_engines
    // And excluding the very oxygen rich engines like the NK-33 with extreme TWR
    // TWR should end somewhere around 80, when ignoring engines like the Merlin 1D, which haven't influenced KSP stock parts
    // KSP stock stops at TWR 27 (see https://wiki.kerbalspaceprogram.com/wiki/Parts#Engines)
    // While it is not trivial to gauge if the engines are too heavy or lack thust
    // I will attempt to do so
    // Compare:
    //      https://wiki.kerbalspaceprogram.com/wiki/LV-909_%22Terrier%22_Liquid_Fuel_Engine
    //      https://en.wikipedia.org/wiki/HM7B
    // Both are ~60 kN upper stage vacuum engines, yet one has a mass of 500 kg and the other 165 kg
    // Compare:
    //      https://wiki.kerbalspaceprogram.com/wiki/Kerbodyne_KR-2L%2B_%22Rhino%22_Liquid_Fuel_Engine
    //      https://en.wikipedia.org/wiki/J-2X
    // The real life engine is a bit smaller (3.0 vs 3.75 meter diameter) and has only 65% of the thrust
    // It however only has a mass of 2470 kg, whereas the game engine has a mass of 9000 kg.
    // All signs that TWR increase needs to be achieved for the most part via mass reduction
    // It is expected that in the future a slightly amount of scaling on thrust will also happen
    kerolox_thrust_factor = 1.0
    kerolox_mass_factor = 0.32

    // Real life monopropellant rockets: http://www.rocket.com/propulsion-systems/monopropellant-rockets
    // Note this data is not for HTP (High-Test Peroxide) based engines, which are currently being developed
    // But hydrazine is very toxic, so lets pretend we're a few years in the future :-P
    // For the thrusts of 1-2 kN, the real-life TWR is around 24-37, so we'll take 30
    // The KSP part: https://wiki.kerbalspaceprogram.com/wiki/Place-Anywhere_7_Linear_RCS_Port has a TWR of 6.8
    // This means that TWR must be raised through mass reduction, because the thrusts are in the right order
    htp_thrust_factor = 1.0
    htp_mass_factor = 0.23
}

//
// Kerosene + LqdOxygen
//

// Rocket engine that is not a multi-mode engine
@PART[*]:HAS[@MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]],!MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],!PROPELLANT[Oxidizer]]]:FOR[ZZZ_REFUSE]
{
    @mass *= #$@REFUSE_EnginesConfiguration/kerolox_mass_factor$

    @MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]]
    {
        !PROPELLANT[LiquidFuel] {}
        !PROPELLANT[Oxidizer] {}

        @minThrust *= #$@REFUSE_EnginesConfiguration/kerolox_thrust_factor$
        @maxThrust *= #$@REFUSE_EnginesConfiguration/kerolox_thrust_factor$

        // configure new propellants
        PROPELLANT
        {
            name = Kerosene
            ratio = 1.0
            DrawGauge = True
        }
        PROPELLANT
        {
            name = LqdOxygen
            ratio = #$@REFUSE_FuelTanksConfiguration/LOx_to_RP1_unit_ratio$
        }
    }
}

// Rocket engine that is part of a multi-mode engine
@PART[*]:HAS[@MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]],@MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],!PROPELLANT[Oxidizer]]]:FOR[ZZZ_REFUSE]
{
    @MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]]
    {
        !PROPELLANT[LiquidFuel] {}
        !PROPELLANT[Oxidizer] {}

        // Because of the air breathing engine, we cannot mess with the mass of the engine
        // instead we put the mass reduction as increased thrust, just for rocket mode
        @minThrust *= #$@REFUSE_EnginesConfiguration/kerolox_thrust_factor$
        @minThrust /= #$@REFUSE_EnginesConfiguration/kerolox_mass_factor$
        @maxThrust *= #$@REFUSE_EnginesConfiguration/kerolox_thrust_factor$
        @maxThrust /= #$@REFUSE_EnginesConfiguration/kerolox_mass_factor$

        // configure new propellants
        PROPELLANT
        {
            name = Kerosene
            ratio = 1.0
            DrawGauge = True
        }
        PROPELLANT
        {
            name = LqdOxygen
            ratio = #$@REFUSE_FuelTanksConfiguration/LOx_to_RP1_unit_ratio$
        }
    }

    @MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],!PROPELLANT[Oxidizer]]
    {
        !PROPELLANT[LiquidFuel] {}

        // configure new propellants
        PROPELLANT
        {
            name = Kerosene
            ratio = 1.0
            DrawGauge = True
        }
    }  
}

//
// Kerosene
//

// Either jet or a nuclear thermal rocket
// TODO: NTR should not be fueled by kerosine, but by a more suitable fuel
@PART[*]:HAS[!MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],@PROPELLANT[Oxidizer]],@MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],!PROPELLANT[Oxidizer]]]:FOR[ZZZ_REFUSE]
{
    @MODULE[ModuleEngine*]:HAS[@PROPELLANT[LiquidFuel],!PROPELLANT[Oxidizer]]
    {
        !PROPELLANT[LiquidFuel] {}

        // configure new propellants
        PROPELLANT
        {
            name = Kerosene
            ratio = 1.0
            DrawGauge = True
        }
    }    
}

//
// HTP
//

// Mono-propellant engine
@PART[*]:HAS[@MODULE[ModuleEngine*]:HAS[@PROPELLANT[MonoPropellant]]]:FOR[ZZZ_REFUSE]
{
    @mass *= #$@REFUSE_EnginesConfiguration/htp_mass_factor$

    @MODULE[ModuleEngine*]:HAS[@PROPELLANT[MonoPropellant]]
    {
        !PROPELLANT[MonoPropellant] {}

        @minThrust *= #$@REFUSE_EnginesConfiguration/htp_thrust_factor$
        @maxThrust *= #$@REFUSE_EnginesConfiguration/htp_thrust_factor$

        // configure new propellants
        PROPELLANT
        {
            name = HTP
            ratio = 1.0
            DrawGauge = True
        }
    }
}

// Mono-propellant thruster
@PART[*]:HAS[@MODULE[ModuleRCS*]:HAS[#resourceName[MonoPropellant]],!MODULE[ModuleCommand]]:FOR[ZZZ_REFUSE]
{
    @mass *= #$@REFUSE_EnginesConfiguration/htp_mass_factor$

    @MODULE[ModuleRCS*]:HAS[#resourceName[MonoPropellant]]
    {
        !PROPELLANT[MonoPropellant] {}

        @thrusterPower *= #$@REFUSE_EnginesConfiguration/htp_thrust_factor$
        // configure new propellants
        @resourceName = HTP
    }
}

// Mono-propellant thruster equiped command module
@PART[*]:HAS[@MODULE[ModuleRCS*]:HAS[#resourceName[MonoPropellant]],@MODULE[ModuleCommand]]:FOR[ZZZ_REFUSE]
{
    @MODULE[ModuleRCS*]:HAS[#resourceName[MonoPropellant]]
    {
        !PROPELLANT[MonoPropellant] {}

        @thrusterPower *= #$@REFUSE_EnginesConfiguration/htp_thrust_factor$
        @thrusterPower /= #$@REFUSE_EnginesConfiguration/htp_mass_factor$ // it's not safe to mess with the mass of the command pod
        // configure new propellants
        @resourceName = HTP
    }
}
