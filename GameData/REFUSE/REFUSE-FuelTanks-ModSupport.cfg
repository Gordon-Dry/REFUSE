//
// All configuration related to fuel tank content
//

//
// IMPORTANT NOTES:
//
// OR statements (symbol: |) do not work inside a HAS statement: https://forum.kerbalspaceprogram.com/index.php?/topic/50533-15x-module-manager-311-november-12th-2018-its-dangerous-to-go-alone-take-those-cats-with-you/&do=findComment&comment=3335515

//
// LqdHydrogen + LqdOxygen
//

@PART[*]:HAS[@RESOURCE[LqdHydrogen],@RESOURCE[Oxidizer]]:FOR[ZZZ_REFUSE]
{
    // dry mass
    REFUSE_wet_mass = #$mass$

    // original liquid hydrogen mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdHydrogen]/density$
    @temp_mass *= #$RESOURCE[LqdHydrogen]/maxAmount$
    LH_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdHydrogen] {}

    // original oxidizer mass
    temp_mass = #$@RESOURCE_DEFINITION[Oxidizer]/density$
    @temp_mass *= #$RESOURCE[Oxidizer]/maxAmount$
    Ox_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[Oxidizer] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdHydrogen
        amount = #$@REFUSE_FuelTanksConfiguration/LH2_units_per_metric_tonne_of_wet_mass_for_LH2_LOx_tank$
        @amount *= #$../LH_mass$
        maxAmount = #$amount$
    }
    RESOURCE
    {
        name = LqdOxygen
        amount = #$@REFUSE_FuelTanksConfiguration/LOx_units_per_metric_tonne_of_wet_mass_for_LH2_LOx_tank$
        @amount *= #$../Ox_mass$
        maxAmount = #$amount$
    }

    // adjust dry mass
    @mass = #$REFUSE_wet_mass$
    @mass *= #$@REFUSE_FuelTanksConfiguration/LH2_LOx_dry_to_wet_ratio$

    // cleanup is done during FINAL to allow RESOURCE to access this as well
}

// LH2O, LH2OCryo: CryoTanks
// We are patching only the CryoTanks tank, because all ModuleB9PartSwitch will be re-configured to use this one
// For now we don't actually use LH20Cryo
@B9_TANK_TYPE[LH2O,LH2OCryo,bdbLH2O,bdbSkylabLH2O]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE]
{
    @title = Hydrolox

    // dry mass
    REFUSE_wet_mass = #$tankMass$ // per liter

    // original liquid hydrogen mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdHydrogen]/density$
    @temp_mass *= #$RESOURCE[LqdHydrogen]/unitsPerVolume$
    LH_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdHydrogen] {}

    // original oxidizer mass
    temp_mass = #$@RESOURCE_DEFINITION[Oxidizer]/density$
    @temp_mass *= #$RESOURCE[Oxidizer]/unitsPerVolume$
    Ox_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[Oxidizer] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdHydrogen
        unitsPerVolume = #$@REFUSE_FuelTanksConfiguration/LH2_units_per_metric_tonne_of_wet_mass_for_LH2_LOx_tank$
        @unitsPerVolume *= #$../LH_mass$
    }
    RESOURCE
    {
        name = LqdOxygen
        unitsPerVolume = #$@REFUSE_FuelTanksConfiguration/LOx_units_per_metric_tonne_of_wet_mass_for_LH2_LOx_tank$
        @unitsPerVolume *= #$../Ox_mass$
    }

    // adjust dry mass
    @tankMass = #$REFUSE_wet_mass$
    @tankMass *= #$@REFUSE_FuelTanksConfiguration/LH2_LOx_dry_to_wet_ratio$
}

// The fuel switch name is on the actual tank part
// Patching during 2nd phase, to prevent that the default fuel becomes this one, rather than Kerolox
@PART[*]:HAS[@MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE_PHASE_2]
{
    @MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
    {
        SUBTYPE
        {
            name = Hydrolox
            title = Hydrolox
            tankType = LH2O
            REFUSE_reset_part_mass = true
        }
    }
}

// ProceduralParts tank
@PART[*]:HAS[@MODULE[TankContentSwitcher]]:FOR[ZZZ_REFUSE]
{
    @MODULE[TankContentSwitcher]:HAS[@TANK_TYPE_OPTION[LqdHydrogen+Oxidizer]]
    {
        @TANK_TYPE_OPTION[LqdHydrogen+Oxidizer]
        {
            @name = Hydrolox
            @dryDensity = #$@REFUSE_FuelTanksConfiguration/LH2_LOx_dry_to_wet_ratio$
            !RESOURCE[LqdHydrogen] {}
            !RESOURCE[Oxidizer] {}

            // configure new propellants
            RESOURCE
            {
                name = LqdHydrogen
                unitsPerT = #$@REFUSE_FuelTanksConfiguration/LH2_units_per_metric_tonne_of_dry_mass_for_LH2_LOx_tank$
            }
            RESOURCE
            {
                name = LqdOxygen
                unitsPerT = #$@REFUSE_FuelTanksConfiguration/LOx_units_per_metric_tonne_of_dry_mass_for_LH2_LOx_tank$
            }
        }
    }
}

//
// LqdHydrogen
//

@PART[*]:HAS[@RESOURCE[LqdHydrogen],!RESOURCE[Oxidizer]]:FOR[ZZZ_REFUSE]
{
    // dry mass
    REFUSE_wet_mass = #$mass$

    // original liquid hydrogen mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdHydrogen]/density$
    @temp_mass *= #$RESOURCE[LqdHydrogen]/maxAmount$
    LH_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdHydrogen] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdHydrogen
        amount = #$@REFUSE_FuelTanksConfiguration/LH2_units_per_metric_tonne_of_wet_mass_for_LH2_tank$
        @amount *= #$../LH_mass$
        maxAmount = #$amount$
    }

    // adjust dry mass
    @mass = #$REFUSE_wet_mass$
    @mass *= #$@REFUSE_FuelTanksConfiguration/LH2_dry_to_wet_ratio$

    // cleanup is done during FINAL to allow RESOURCE to access this as well
}

// LH2, LH2Cryo: CryoTanks
// We are patching only the CryoTanks tank, because all ModuleB9PartSwitch will be re-configured to use this one
// For now we don't use LH2Cryo
@B9_TANK_TYPE[LH2,LH2Cryo,bdbLH2]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE]
{
    @title = LqdHydrogen

    // dry mass
    REFUSE_wet_mass = #$tankMass$ // per liter

    // original liquid hydrogen mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdHydrogen]/density$
    @temp_mass *= #$RESOURCE[LqdHydrogen]/unitsPerVolume$
    LH_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdHydrogen] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdHydrogen
        unitsPerVolume = #$@REFUSE_FuelTanksConfiguration/LH2_units_per_metric_tonne_of_wet_mass_for_LH2_tank$
        @unitsPerVolume *= #$../LH_mass$
    }

    // adjust dry mass
    @tankMass = #$REFUSE_wet_mass$
    @tankMass *= #$@REFUSE_FuelTanksConfiguration/LH2_dry_to_wet_ratio$
}

// The fuel switch name is on the actual tank part
// Patching during 2nd phase, to prevent that the default fuel becomes this one, rather than Kerolox
@PART[*]:HAS[@MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE_PHASE_2]
{
    @MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
    {
        SUBTYPE
        {
            name = LqdHydrogen
            title = LqdHydrogen
            tankType = LH2
            REFUSE_reset_part_mass = true
        }
    }
}

// ProceduralParts tank
@PART[*]:HAS[@MODULE[TankContentSwitcher]]:FOR[ZZZ_REFUSE]
{
    @MODULE[TankContentSwitcher]:HAS[@TANK_TYPE_OPTION[LqdHydrogen]]
    {
        @TANK_TYPE_OPTION[LqdHydrogen]
        {
            @name = LqdHydrogen
            @dryDensity = #$@REFUSE_FuelTanksConfiguration/LH2_dry_to_wet_ratio$
            !RESOURCE[LqdHydrogen] {}

            // configure new propellants
            RESOURCE
            {
                name = LqdHydrogen
                unitsPerT = #$@REFUSE_FuelTanksConfiguration/LH2_units_per_metric_tonne_of_dry_mass_for_LH2_tank$
            }
        }
    }
}

//
// LqdMethane + LqdOxygen
//

@PART[*]:HAS[@RESOURCE[LqdMethane],@RESOURCE[Oxidizer]]:FOR[ZZZ_REFUSE]
{
    // dry mass
    REFUSE_wet_mass = #$mass$

    // original liquid methane mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdMethane]/density$
    @temp_mass *= #$RESOURCE[LqdMethane]/maxAmount$
    LM_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdMethane] {}

    // original oxidizer mass
    temp_mass = #$@RESOURCE_DEFINITION[Oxidizer]/density$
    @temp_mass *= #$RESOURCE[Oxidizer]/maxAmount$
    Ox_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[Oxidizer] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdMethane
        amount = #$@REFUSE_FuelTanksConfiguration/LM_units_per_metric_tonne_of_wet_mass_for_LM_LOx_tank$
        @amount *= #$../LM_mass$
        maxAmount = #$amount$
    }
    RESOURCE
    {
        name = LqdOxygen
        amount = #$@REFUSE_FuelTanksConfiguration/LOx_units_per_metric_tonne_of_wet_mass_for_LM_LOx_tank$
        @amount *= #$../Ox_mass$
        maxAmount = #$amount$
    }

    // adjust dry mass
    @mass = #$REFUSE_wet_mass$
    @mass *= #$@REFUSE_FuelTanksConfiguration/LM_LOx_dry_to_wet_ratio$

    // cleanup is done during FINAL to allow RESOURCE to access this as well
}

// LMOx: CryoTanks
// We are patching only the CryoTanks tank, because all ModuleB9PartSwitch will be re-configured to use this one
@B9_TANK_TYPE[LMOx]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE]
{
    @title = Methalox

    // dry mass
    REFUSE_wet_mass = #$tankMass$ // per liter

    // original liquid methane mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdMethane]/density$
    @temp_mass *= #$RESOURCE[LqdMethane]/unitsPerVolume$
    LM_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdMethane] {}

    // original oxidizer mass
    temp_mass = #$@RESOURCE_DEFINITION[Oxidizer]/density$
    @temp_mass *= #$RESOURCE[Oxidizer]/unitsPerVolume$
    Ox_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[Oxidizer] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdMethane
        unitsPerVolume = #$@REFUSE_FuelTanksConfiguration/LM_units_per_metric_tonne_of_wet_mass_for_LM_LOx_tank$
        @unitsPerVolume *= #$../LM_mass$
    }
    RESOURCE
    {
        name = LqdOxygen
        unitsPerVolume = #$@REFUSE_FuelTanksConfiguration/LOx_units_per_metric_tonne_of_wet_mass_for_LM_LOx_tank$
        @unitsPerVolume *= #$../Ox_mass$
    }

    // adjust dry mass
    @tankMass = #$REFUSE_wet_mass$
    @tankMass *= #$@REFUSE_FuelTanksConfiguration/LM_LOx_dry_to_wet_ratio$
}

// The fuel switch name is on the actual tank part
// Patching during 2nd phase, to prevent that the default fuel becomes this one, rather than Kerolox
@PART[*]:HAS[@MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE_PHASE_2]
{
    @MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
    {
        SUBTYPE
        {
            name = Methalox
            title = MethaLOx
            tankType = LMOx
            REFUSE_reset_part_mass = true
        }
    }
}

// ProceduralParts tank
@PART[*]:HAS[@MODULE[TankContentSwitcher]]:FOR[ZZZ_REFUSE]
{
    @MODULE[TankContentSwitcher]:HAS[@TANK_TYPE_OPTION[LqdMethane+Oxidizer]]
    {
        @TANK_TYPE_OPTION[LqdMethane+Oxidizer]
        {
            @name = MethaLOx
            @dryDensity = #$@REFUSE_FuelTanksConfiguration/LM_LOx_dry_to_wet_ratio$
            !RESOURCE[LqdMethane] {}
            !RESOURCE[Oxidizer] {}

            // configure new propellants
            RESOURCE
            {
                name = LqdMethane
                unitsPerT = #$@REFUSE_FuelTanksConfiguration/LM_units_per_metric_tonne_of_dry_mass_for_LM_LOx_tank$
            }
            RESOURCE
            {
                name = LqdOxygen
                unitsPerT = #$@REFUSE_FuelTanksConfiguration/LOx_units_per_metric_tonne_of_dry_mass_for_LM_LOx_tank$
            }
        }
    }
}

//
// LqdMethane
//

@PART[*]:HAS[@RESOURCE[LqdMethane],!RESOURCE[Oxidizer]]:FOR[ZZZ_REFUSE]
{
    // dry mass
    REFUSE_wet_mass = #$mass$

    // original liquid methane mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdMethane]/density$
    @temp_mass *= #$RESOURCE[LqdMethane]/maxAmount$
    LM_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdMethane] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdMethane
        amount = #$@REFUSE_FuelTanksConfiguration/LM_units_per_metric_tonne_of_wet_mass_for_LM_tank$
        @amount *= #$../LM_mass$
        maxAmount = #$amount$
    }

    // adjust dry mass
    @mass = #$REFUSE_wet_mass$
    @mass *= #$@REFUSE_FuelTanksConfiguration/LM_dry_to_wet_ratio$

    // cleanup is done during FINAL to allow RESOURCE to access this as well
}

// LM: CryoTanks
// We are patching only the CryoTanks tank, because all ModuleB9PartSwitch will be re-configured to use this one
@B9_TANK_TYPE[LM]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE]
{
    @title = LqdMethane

    // dry mass
    REFUSE_wet_mass = #$tankMass$ // per liter

    // original liquid methane mass
    temp_mass = #$@RESOURCE_DEFINITION[LqdMethane]/density$
    @temp_mass *= #$RESOURCE[LqdMethane]/unitsPerVolume$
    LM_mass = #$temp_mass$
    @REFUSE_wet_mass += #$temp_mass$
    -temp_mass = delete
    !RESOURCE[LqdMethane] {}

    // configure new propellants
    RESOURCE
    {
        name = LqdMethane
        unitsPerVolume = #$@REFUSE_FuelTanksConfiguration/LM_units_per_metric_tonne_of_wet_mass_for_LM_tank$
        @unitsPerVolume *= #$../LM_mass$
    }

    // adjust dry mass
    @tankMass = #$REFUSE_wet_mass$
    @tankMass *= #$@REFUSE_FuelTanksConfiguration/LM_dry_to_wet_ratio$
}

// The fuel switch name is on the actual tank part
// Patching during 2nd phase, to prevent that the default fuel becomes this one, rather than Kerolox
@PART[*]:HAS[@MODULE[ModuleB9PartSwitch]]:NEEDS[B9PartSwitch,CryoTanks]:FOR[ZZZ_REFUSE_PHASE_2]
{
    @MODULE[ModuleB9PartSwitch]:HAS[#moduleID[fuelSwitch]]
    {
        SUBTYPE
        {
            name = LqdMethane
            title = LqdMethane
            tankType = LM
            REFUSE_reset_part_mass = true
        }
    }
}

// ProceduralParts tank
@PART[*]:HAS[@MODULE[TankContentSwitcher]]:FOR[ZZZ_REFUSE]
{
    @MODULE[TankContentSwitcher]:HAS[@TANK_TYPE_OPTION[LqdMethane]]
    {
        @TANK_TYPE_OPTION[LqdMethane]
        {
            @name = LqdMethane
            @dryDensity = #$@REFUSE_FuelTanksConfiguration/LM_dry_to_wet_ratio$
            !RESOURCE[LqdMethane] {}

            // configure new propellants
            RESOURCE
            {
                name = LqdMethane
                unitsPerT = #$@REFUSE_FuelTanksConfiguration/LM_units_per_metric_tonne_of_dry_mass_for_LM_tank$
            }
        }
    }
}

// Launch clamps' fuels are converted
@PART[*]:HAS[@MODULE[LaunchClamp],@MODULE[ModuleGenerator]]:NEEDS[!RealismOverhaul]:FOR[ZZZ_REFUSE]
{
	@MODULE[ModuleGenerator],*
	{
		@OUTPUT_RESOURCE,*:HAS[#name[LiquidFuel]]
		{
			@name = Kerosene
		}
		@OUTPUT_RESOURCE,*:HAS[#name[Oxidizer]]
		{
			@name = LqdOxygen
		}
		@OUTPUT_RESOURCE,*:HAS[#name[MonoPropellant]]
		{
			@name = HTP
		}
	}
}
